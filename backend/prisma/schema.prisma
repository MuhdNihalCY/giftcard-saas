// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MERCHANT
  CUSTOMER
}

enum GiftCardStatus {
  ACTIVE
  REDEEMED
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  RAZORPAY
  UPI
}

enum GatewayType {
  STRIPE
  PAYPAL
  RAZORPAY
  UPI
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
}

enum CommissionType {
  PERCENTAGE
  FIXED
}

enum PayoutSchedule {
  IMMEDIATE
  DAILY
  WEEKLY
  MONTHLY
}

enum FeatureFlagCategory {
  PAGE
  FEATURE
}

enum FeatureFlagTargetRole {
  MERCHANT
  CUSTOMER
  ALL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum RedemptionMethod {
  QR_CODE
  CODE_ENTRY
  LINK
  API
}

enum TransactionType {
  PURCHASE
  REDEMPTION
  REFUND
  EXPIRY
}

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String    @map("password_hash")
  firstName           String?   @map("first_name")
  lastName            String?   @map("last_name")
  role                UserRole  @default(CUSTOMER)
  businessName        String?   @map("business_name")
  businessLogo        String?   @map("business_logo")
  isEmailVerified     Boolean   @default(false) @map("is_email_verified")
  isActive            Boolean   @default(true) @map("is_active")
  merchantBalance     Decimal   @default(0) @map("merchant_balance") @db.Decimal(10, 2)
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  twoFactorEnabled    Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret     String?   @map("two_factor_secret")
  twoFactorBackupCodes Json?    @map("two_factor_backup_codes") // Array of hashed backup codes
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  giftCards               GiftCard[]
  giftCardTemplates       GiftCardTemplate[]
  giftCardProducts        GiftCardProduct[]
  payments                Payment[]
  redemptions             Redemption[]
  transactions            Transaction[]
  apiKeys                 ApiKey[]
  webhooks                Webhook[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  payouts                 Payout[]
  refreshTokens           RefreshToken[]
  merchantPaymentGateways MerchantPaymentGateway[]
  payoutSettings          PayoutSettings?
  commissionSettings      CommissionSettings[]

  @@map("users")
}

model GiftCardTemplate {
  id          String   @id @default(uuid())
  merchantId  String   @map("merchant_id")
  name        String
  description String?
  designData  Json     @map("design_data") // Colors, images, layout
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  merchant        User              @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  giftCards       GiftCard[]
  giftCardProducts GiftCardProduct[]

  @@map("gift_card_templates")
}

model GiftCard {
  id                     String         @id @default(uuid())
  merchantId             String         @map("merchant_id")
  code                   String         @unique
  qrCodeUrl              String?        @map("qr_code_url")
  value                  Decimal        @db.Decimal(10, 2)
  currency               String         @default("USD")
  balance                Decimal        @db.Decimal(10, 2)
  status                 GiftCardStatus @default(ACTIVE)
  expiryDate             DateTime?      @map("expiry_date")
  templateId             String?        @map("template_id")
  productId              String?        @map("product_id")
  customMessage          String?        @map("custom_message") @db.Text
  recipientEmail         String?        @map("recipient_email")
  recipientName          String?        @map("recipient_name")
  allowPartialRedemption Boolean        @default(true) @map("allow_partial_redemption")
  shareToken             String?        @unique @map("share_token")
  shareTokenExpiry       DateTime?      @map("share_token_expiry")
  shareEnabled           Boolean        @default(true) @map("share_enabled")
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")

  // Relations
  merchant     User              @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  template     GiftCardTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  product      GiftCardProduct?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  payments     Payment[]
  redemptions  Redemption[]
  transactions Transaction[]

  @@index([merchantId])
  @@index([code])
  @@index([status])
  @@index([productId])
  @@map("gift_cards")
}

model GiftCardProduct {
  id               String   @id @default(uuid())
  merchantId       String   @map("merchant_id")
  name             String
  description      String?  @db.Text
  image            String?
  minAmount        Decimal? @map("min_amount") @db.Decimal(10, 2) // Gift card value (what customer gets)
  maxAmount        Decimal? @map("max_amount") @db.Decimal(10, 2) // Gift card value (what customer gets)
  minSalePrice     Decimal? @map("min_sale_price") @db.Decimal(10, 2) // What customer pays
  maxSalePrice     Decimal? @map("max_sale_price") @db.Decimal(10, 2) // What customer pays
  allowCustomAmount Boolean @default(false) @map("allow_custom_amount")
  fixedAmounts     Json?    @map("fixed_amounts") // Array of gift card values
  fixedSalePrices  Json?    @map("fixed_sale_prices") // Array of sale prices (corresponding to fixedAmounts)
  currency         String   @default("USD")
  expiryDays       Int?     @map("expiry_days") // Days until expiry
  templateId       String?  @map("template_id")
  category         String?
  tags             Json?    // Array of strings
  isActive         Boolean  @default(true) @map("is_active")
  isPublic         Boolean  @default(false) @map("is_public") // Make product visible to all users
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  merchant  User       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  template  GiftCardTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  giftCards GiftCard[]

  @@index([merchantId])
  @@index([isActive])
  @@index([isPublic])
  @@index([category])
  @@map("gift_card_products")
}

model Payment {
  id              String        @id @default(uuid())
  giftCardId      String        @map("gift_card_id")
  customerId      String?       @map("customer_id")
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")
  paymentMethod   PaymentMethod @map("payment_method")
  paymentIntentId String        @map("payment_intent_id")
  status          PaymentStatus @default(PENDING)
  transactionId   String?       @map("transaction_id")
  commissionAmount Decimal?     @map("commission_amount") @db.Decimal(10, 2)
  netAmount       Decimal?      @map("net_amount") @db.Decimal(10, 2)
  ipAddress       String?       @map("ip_address")
  userAgent       String?       @map("user_agent") @db.Text
  deviceFingerprint String?     @map("device_fingerprint")
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  customer User?    @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([giftCardId])
  @@index([customerId])
  @@index([paymentIntentId])
  @@map("payments")
}

model Redemption {
  id               String           @id @default(uuid())
  giftCardId       String           @map("gift_card_id")
  merchantId       String           @map("merchant_id")
  amount           Decimal          @db.Decimal(10, 2)
  balanceBefore    Decimal          @map("balance_before") @db.Decimal(10, 2)
  balanceAfter     Decimal          @map("balance_after") @db.Decimal(10, 2)
  redemptionMethod RedemptionMethod @map("redemption_method")
  location         String?
  notes            String?          @db.Text
  createdAt        DateTime         @default(now()) @map("created_at")

  // Relations
  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  merchant User     @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([giftCardId])
  @@index([merchantId])
  @@map("redemptions")
}

model Transaction {
  id            String          @id @default(uuid())
  giftCardId    String          @map("gift_card_id")
  type          TransactionType
  amount        Decimal         @db.Decimal(10, 2)
  balanceBefore Decimal         @map("balance_before") @db.Decimal(10, 2)
  balanceAfter  Decimal         @map("balance_after") @db.Decimal(10, 2)
  userId        String?         @map("user_id")
  metadata      Json?
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relations
  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([giftCardId])
  @@index([userId])
  @@index([type])
  @@map("transactions")
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  keyHash     String    @unique @map("key_hash")
  name        String
  permissions Json // Array of permissions
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("api_keys")
}

model Webhook {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  url             String
  events          Json // Array of event types
  secret          String
  isActive        Boolean   @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("webhooks")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model Payout {
  id              String       @id @default(uuid())
  merchantId      String       @map("merchant_id")
  amount          Decimal      @db.Decimal(10, 2)
  currency        String       @default("USD")
  status          PayoutStatus @default(PENDING)
  payoutMethod    String       @map("payout_method") // STRIPE_CONNECT, PAYPAL, BANK_TRANSFER
  payoutAccountId String?      @map("payout_account_id")
  transactionId   String?      @map("transaction_id")
  commissionAmount Decimal?    @map("commission_amount") @db.Decimal(10, 2)
  netAmount       Decimal      @map("net_amount") @db.Decimal(10, 2)
  scheduledFor    DateTime?    @map("scheduled_for")
  retryCount      Int          @default(0) @map("retry_count")
  webhookData     Json?        @map("webhook_data")
  processedAt     DateTime?    @map("processed_at")
  failureReason   String?      @map("failure_reason") @db.Text
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  merchant User @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([status])
  @@index([createdAt])
  @@index([scheduledFor])
  @@map("payouts")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}


model CommunicationSettings {
  id               String   @id @default(uuid())
  emailEnabled     Boolean  @default(true) @map("email_enabled")
  smsEnabled       Boolean  @default(true) @map("sms_enabled")
  otpEnabled       Boolean  @default(true) @map("otp_enabled")
  pushEnabled      Boolean  @default(false) @map("push_enabled")
  emailRateLimit   Int      @default(100) @map("email_rate_limit") // per hour
  smsRateLimit     Int      @default(50) @map("sms_rate_limit") // per hour
  otpRateLimit     Int      @default(10) @map("otp_rate_limit") // per hour per user
  otpExpiryMinutes Int      @default(10) @map("otp_expiry_minutes")
  otpLength        Int      @default(6) @map("otp_length")
  updatedBy        String?  @map("updated_by")
  updatedAt        DateTime @updatedAt @map("updated_at")
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("communication_settings")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  userEmail    String?  @map("user_email")
  action       String   // e.g., "LOGIN", "PAYMENT_CREATED", "GIFT_CARD_DELETED"
  resourceType String   @map("resource_type") // e.g., "User", "Payment", "GiftCard"
  resourceId   String?  @map("resource_id")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent") @db.Text
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("audit_logs")
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  token       String   @unique
  deviceName  String?  @map("device_name")
  deviceType  String?  @map("device_type") // MOBILE, DESKTOP, TABLET
  userAgent   String?  @map("user_agent") @db.Text
  ipAddress   String?  @map("ip_address")
  lastUsedAt  DateTime @map("last_used_at")
  expiresAt   DateTime @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model CommunicationLog {
  id           String   @id @default(uuid())
  channel      String // EMAIL, SMS, OTP, PUSH
  recipient    String
  subject      String?
  message      String?  @db.Text
  status       String // SENT, FAILED, PENDING, BLOCKED
  errorMessage String?  @map("error_message") @db.Text
  metadata     Json?
  userId       String?  @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([channel])
  @@index([recipient])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@map("communication_logs")
}

model CommunicationTemplate {
  id        String   @id @default(uuid())
  name      String
  type      String // EMAIL, SMS, OTP
  subject   String?
  body      String   @db.Text
  variables Json? // Available template variables
  isActive  Boolean  @default(true) @map("is_active")
  version   Int      @default(1)
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([name, type, version])
  @@index([type])
  @@index([isActive])
  @@map("communication_templates")
}

model OTP {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  identifier String // email or phone number
  code       String
  type       String // LOGIN, VERIFICATION, PASSWORD_RESET, TRANSACTION
  expiresAt  DateTime @map("expires_at")
  used       Boolean  @default(false)
  attempts   Int      @default(0)
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([identifier])
  @@index([code])
  @@index([userId])
  @@index([type])
  @@index([expiresAt])
  @@map("otps")
}

model MerchantPaymentGateway {
  id                String            @id @default(uuid())
  merchantId        String            @map("merchant_id")
  gatewayType       GatewayType       @map("gateway_type")
  isActive          Boolean           @default(false) @map("is_active")
  credentials       String            @db.Text // Encrypted JSON
  connectAccountId  String?           @map("connect_account_id")
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  metadata          Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  // Relations
  merchant User @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, gatewayType])
  @@index([merchantId])
  @@index([gatewayType])
  @@index([isActive])
  @@index([verificationStatus])
  @@map("merchant_payment_gateways")
}

model CommissionSettings {
  id            String         @id @default(uuid())
  merchantId    String?        @map("merchant_id") // null for global settings
  commissionRate Decimal       @map("commission_rate") @db.Decimal(5, 2) // e.g., 5.00 for 5%
  commissionType CommissionType @map("commission_type")
  isActive      Boolean        @default(true) @map("is_active")
  appliesTo     Json?          @map("applies_to") // Array of payment methods
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  merchant User? @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([isActive])
  @@map("commission_settings")
}

model PayoutSettings {
  id                 String         @id @default(uuid())
  merchantId         String         @unique @map("merchant_id")
  payoutMethod       String         @map("payout_method") // STRIPE_CONNECT, PAYPAL, BANK_TRANSFER
  payoutSchedule     PayoutSchedule @default(IMMEDIATE) @map("payout_schedule")
  minimumPayoutAmount Decimal       @default(10) @map("minimum_payout_amount") @db.Decimal(10, 2)
  payoutAccountId    String?       @map("payout_account_id")
  isActive           Boolean        @default(true) @map("is_active")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  // Relations
  merchant User @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([isActive])
  @@map("payout_settings")
}

model FeatureFlag {
  id          String                @id @default(uuid())
  featureKey  String                @unique @map("feature_key")
  featureName String                @map("feature_name")
  description String?               @db.Text
  category    FeatureFlagCategory
  targetRole  FeatureFlagTargetRole @map("target_role")
  isEnabled   Boolean               @default(true) @map("is_enabled")
  metadata    Json?
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  @@index([featureKey])
  @@index([targetRole])
  @@index([category])
  @@index([isEnabled])
  @@map("feature_flags")
}
